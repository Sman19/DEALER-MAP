  <!-- Papa Parse (CSV parser) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Map setup
    const map = L.map('map', { zoomControl: true }).setView([39.5, -98.35], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markerLayer = L.layerGroup().addTo(map);
    const allMarkers = [];
    const bounds = L.latLngBounds([]);
    const searchInput = document.getElementById('search');
    const shownCount = document.getElementById('shownCount');
    const totalCount = document.getElementById('totalCount');

    function addPoint(lat, lng, name, state = '', code = '', phone = '') {
      const m = L.circleMarker([lat, lng], {
        radius: 5, weight: 1, opacity: 1, fillOpacity: 0.85
      }).bindPopup(`
        <div class="tooltip-title">${name}</div>
        ${state ? `<div><b>State:</b> ${state}</div>` : ''}
        ${code  ? `<div><b>Dealer Code:</b> ${code}</div>` : ''}
        ${phone ? `<div><b>Phone:</b> ${phone}</div>` : ''}
      `);

      m.meta = {
        name: (name||'').toLowerCase(),
        state: (state||'').toLowerCase(),
        code: (code||'').toLowerCase(),
        phone: (phone||'').toLowerCase()
      };

      allMarkers.push(m);
      bounds.extend([lat, lng]);
    }

    function renderMarkers(filterText = '') {
      markerLayer.clearLayers();
      const f = (filterText||'').trim().toLowerCase();
      let visible = 0;

      for (const m of allMarkers) {
        const hit = !f || m.meta.name.includes(f) || m.meta.state.includes(f) ||
                    m.meta.code.includes(f) || m.meta.phone.includes(f);
        if (hit) { m.addTo(markerLayer); visible++; }
      }

      shownCount.textContent = `${visible} shown`;
      totalCount.textContent = allMarkers.length;

      if (visible > 0) {
        try { map.fitBounds(markerLayer.getBounds().pad(0.2)); } catch {}
      }
    }

    // --- Papa Parse CSV Loader ---
    Papa.parse("bmw_dealers.CSV", {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        results.data.forEach(function(r) {
          const name  = (r.name || '').trim();
          const state = (r.state || '').trim();
          const code  = (r.dealer_code || '').trim();
          const phone = (r.phone || '').trim();
          const lat   = parseFloat(r.lat);
          const lng   = parseFloat(r.lng);

          if (name && !isNaN(lat) && !isNaN(lng)) {
            addPoint(lat, lng, name, state, code, phone);
          }
        });

        renderMarkers();
        if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
      }
    });

    // --- Search & Reset ---
    searchInput.addEventListener('input', e => renderMarkers(e.target.value));
    document.getElementById('resetBtn').addEventListener('click', () => {
      searchInput.value = '';
      renderMarkers();
      if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
    });
  </script>
